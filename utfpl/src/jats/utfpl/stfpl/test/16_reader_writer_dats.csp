// ===============================

#import "MyLib";  // import the library

// =====================

// library data structure (e.g. tuple, list)
var<MyLibObj> sys_mylib_obj = new MyLibObj();

// Set the initial capacity to 10.
var<AtomRefManager> atom_ref_manager = new AtomRefManager(10);

// Set the initial capacity to 10.
var<ArrayRefManager> array_ref_manager = new ArrayRefManager(10);

// =====================

// Stack Operation
var<PStack> sys_gstack = new PStack();

// thread id allocator
var<Allocator> sys_tid_allocator = new Allocator();  // todo: improve

// =====================

var sys_thread_num = 1;

channel sys_ch_sch 0;

var sch_sys_tid;
var sch_fn;
var sch_args;

sch_thread_starter(sys_tid, fn, args) =
thread_init{
  // Create a list with one element.
  var __temp_list_args = sys_mylib_obj.list_nil ();
  __temp_list_args = sys_mylib_obj.list_cons (args, __temp_list_args);
  sys_gstack.add_frame(sys_tid, __temp_list_args);
} ->
  if (fn == 4) {
    producer_76(sys_tid); proc_thread_finalize(sys_tid)
    |||
    Scheduler()
  }
  else if (fn == 6) {
    consumer_88(sys_tid); proc_thread_finalize(sys_tid)
    |||
    Scheduler()
  }
  else {Skip}
;

Scheduler() = (atomic{sys_ch_sch?sys_tid.fn.args -> 
                      {sys_thread_num++;
                       sch_sys_tid = sys_tid;
                       sch_fn = fn;
                       sch_args = args;
                      } -> Skip
                      };
  sch_thread_starter(sch_sys_tid, sch_fn, sch_args)
  )
  []
  ifa (sys_thread_num == 0) {Skip}
  ;

proc_thread_finalize(sys_tid) = 
  thread_finalize{
    sys_gstack.delete_frame(sys_tid); 
    sys_thread_num--;
    sys_tid_allocator.release(sys_tid);
  } -> Skip;

sys_thread_create (tid, fn, args) = sys_ch_sch!tid.fn.args -> Skip;

// =====================

var mutex[10];  // 10 mutex

var<Allocator> sys_mutex_manager = new Allocator();

// ====================
conats_mutex_acquire(sys_tid) = sys_mutex_lock_impl (sys_tid, sys_gstack.frame_get(sys_tid, 0, 0));

sys_mutex_lock_impl(sys_tid, m) = [mutex[m] == 0] mlock{mutex[m] = 1} -> Skip;
// ====================
conats_mutex_release(sys_tid) = sys_mutex_unlock_impl (sys_tid, sys_gstack.frame_get(sys_tid, 0, 0));

sys_mutex_unlock_impl(sys_tid, m) = sys_munlock{mutex[m] = 0} -> Skip;
// ======================

var cond_holder[10];  // 10 condition

var<Allocator> sys_cond_manager = new Allocator();

channel cond_chan[10] 0;
var cond_count = 0;

// ====================

conats_shared_acquire(sys_tid) = conats_shared_acquire_impl(sys_tid, sys_gstack.frame_get(sys_tid, 0, 0));
//  tup = sys_gstack.frame_get(sys_tid, 0, 0)
//  a = sys_mylib_obj.getTupleElement(tup, 0);
//  mutex = sys_mylib_obj.getTupleElement(tup, 1);
//  cond = sys_mylib_obj.getTupleElement(tup, 2);
conats_shared_acquire_impl(sys_tid, tup) = atomic{
    {sys_gstack.frame_push(sys_tid, sys_mylib_obj.getTupleElement(tup, 0))} ->
    sys_mutex_lock_impl(sys_tid, sys_mylib_obj.getTupleElement(tup, 1))
    };
// ====================
conats_shared_release(sys_tid) = conats_shared_release_impl(sys_tid, 
                                          sys_gstack.frame_get(sys_tid, 0, 0),
                                          sys_gstack.frame_get(sys_tid, 0, 1)
                                          );

conats_shared_release_impl(sys_tid, tup, a) = 
    sys_mutex_unlock_impl(sys_tid, sys_mylib_obj.getTupleElement(tup, 1));
// ====================
conats_shared_signal(sys_tid) = conats_shared_signal_impl(sys_tid, sys_gstack.frame_get(sys_tid, 0, 0));

conats_shared_signal_impl(sys_tid, tup) = 
    sys_cond_signal_impl(sys_tid, sys_mylib_obj.getTupleElement(tup, 2));

sys_cond_signal_impl(sys_tid, c) = atomic {if (cond_holder[c] > 0) {

          csub{cond_holder[c]--;} ->

          cond_chan[c]!1

          -> Skip

        }};    
// ====================

conats_shared_condwait(sys_tid) = 
    conats_shared_condwait_impl(sys_tid, sys_gstack.frame_get(sys_tid, 0, 0));

conats_shared_condwait_impl(sys_tid, tup) = sys_cond_wait_impl(sys_tid, 
                                  sys_mylib_obj.getTupleElement(tup, 2),  // cond
                                  sys_mylib_obj.getTupleElement(tup, 1));  // mutex

sys_cond_wait_impl(sys_tid, c, m) = atomic{
  cadd{cond_holder[c]++;} -> 
  sys_mutex_unlock_impl(sys_tid, m); 
  cond_chan[c]?_ -> 
  sys_mutex_lock_impl(sys_tid, m)
  };

// ====================
sys_cond_broadcast(sys_tid) = sys_cond_broadcast_impl(sys_tid, sys_gstack.frame_get(sys_tid, 0, 0));

sys_cond_broadcast_impl(sys_tid, c) = atomic{if (cond_holder[c] > 0) {

          sys_signaln(c, cond_holder[c]); csub{cond_holder[c]=0;} -> Skip

        }};

sys_signaln(c, n) = if (n > 0) {cond_chan[c]!1 -> sys_signaln(c, n-1)}
                else {Skip}
                ;

// ===============================

// #define sys_list_nil  sys_list_manager.list_nil ();
// #define sys_list_cons(x, xs) sys_list_manager.list_cons (x, xs);
// #define sys_list_get_header(xs) sys_list_manager.list_get_header (xs);
// #define sys_list_get_tail(xs) sys_list_manager.list_get_tail (xs);
// #define sys_list_is_nil(xs) sys_list_manager.list_is_nil (xs);

// ===============================
// global variable for assertion
var sys_assert_var = true;

// =====================

var gref_63;
var lin_ref_64;
var s_65;
var tid1_100;
var tid2_101;

lin_atomref_update_66(sys_tid) =
  lin_atomref_update_66__1{  var ref_69 = sys_mylib_obj.castvwtp0(sys_gstack.frame_get(sys_tid, 0, 0));
  sys_gstack.frame_push(sys_tid, ref_69);
  atom_ref_manager.setElement(ref_69, sys_gstack.frame_get(sys_tid, 0, 1))
  } ->
  lin_atomref_update_66__2{  var lref_70 = sys_mylib_obj.castvwtp0(sys_gstack.frame_get(sys_tid, 0, 2));
  sys_gstack.frame_push(sys_tid, lref_70);
  } ->
  Skip
  ;

lin_atomref_get_71(sys_tid) =
  lin_atomref_get_71__1{  var ref_73 = sys_mylib_obj.castvwtp0(sys_gstack.frame_get(sys_tid, 0, 0));
  sys_gstack.frame_push(sys_tid, ref_73);
  var v_74 = atom_ref_manager.getElement(ref_73);
  sys_gstack.frame_push(sys_tid, v_74);
  } ->
  lin_atomref_get_71__2{  var lref_75 = sys_mylib_obj.castvwtp0(sys_gstack.frame_get(sys_tid, 0, 1));
  var ret4_id = sys_mylib_obj.createTuple(2);
  sys_mylib_obj.setTupleElement(ret4_id, 0, lref_75);
  sys_mylib_obj.setTupleElement(ret4_id, 1, sys_gstack.frame_get(sys_tid, 0, 2));
  sys_gstack.frame_push(sys_tid, ret4_id);
  } ->
  Skip
  ;

loop_79(sys_tid) =
  loop_79__1{  var loop_clo26_id = sys_mylib_obj.createTuple2(3, sys_gstack.frame_get(sys_tid, 0, 1));
  var x_7727_id = sys_mylib_obj.getTupleElement(sys_gstack.frame_get(sys_tid, 0, 1), 0);;
  sys_gstack.frame_push(sys_tid, x_7727_id);
  var __temp_list_args = sys_mylib_obj.list_nil ();
  __temp_list_args = sys_mylib_obj.list_cons (sys_gstack.frame_get(sys_tid, 0, 0), __temp_list_args);
  sys_gstack.add_frame(sys_tid, __temp_list_args);
  } ->
  lin_atomref_get_71(sys_tid);
  loop_79__2{  var temp8_id = sys_gstack.retopr_frame(sys_tid);
  var ref_81 = sys_mylib_obj.getTupleElement(temp8_id, 0);;
  sys_gstack.frame_push(sys_tid, ref_81);
  var v_82 = sys_mylib_obj.getTupleElement(temp8_id, 1);;
  var temp9_id = call(eq, v_82, 1);
  sys_gstack.frame_push(sys_tid, temp9_id);
  } ->
  if (sys_gstack.frame_get_bool(sys_tid, 0, 4)) {
    loop_79__1{  var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (s_65, __temp_list_args);
    __temp_list_args = sys_mylib_obj.list_cons (sys_gstack.frame_get(sys_tid, 0, 3), __temp_list_args);
    sys_gstack.add_frame(sys_tid, __temp_list_args);
    } ->
    conats_shared_condwait(sys_tid);
    loop_79__2{  var ref_83 = sys_gstack.retopr_frame(sys_tid);
    var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (ref_83, __temp_list_args);
    __temp_list_args = sys_mylib_obj.list_cons (sys_gstack.frame_get(sys_tid, 0, 1), __temp_list_args);
    sys_gstack.reload_frame(sys_tid, __temp_list_args);
    } ->
    loop_79(sys_tid)
  } else {
    loop_79__1{  var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (sys_gstack.frame_get(sys_tid, 0, 3), __temp_list_args);
    sys_gstack.add_frame(sys_tid, __temp_list_args);
    } ->
    lin_atomref_get_71(sys_tid);
    loop_79__2{  var temp37_id = sys_gstack.retopr_frame(sys_tid);
    var ref38_id = sys_mylib_obj.getTupleElement(temp37_id, 0);;
    var v39_id = sys_mylib_obj.getTupleElement(temp37_id, 1);;
    var temp40_id = call(add, v39_id, 1);
    var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (ref38_id, __temp_list_args);
    __temp_list_args = sys_mylib_obj.list_cons (temp40_id, __temp_list_args);
    sys_gstack.add_frame(sys_tid, __temp_list_args);
    } ->
    lin_atomref_update_66(sys_tid);
    loop_79__3{  var ref41_id = sys_gstack.retopr_frame(sys_tid);
    var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (s_65, __temp_list_args);
    __temp_list_args = sys_mylib_obj.list_cons (ref41_id, __temp_list_args);
    sys_gstack.add_frame(sys_tid, __temp_list_args);
    } ->
    conats_shared_signal(sys_tid);
    loop_79__4{  var ref42_id = sys_gstack.retopr_frame(sys_tid);
    var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (s_65, __temp_list_args);
    __temp_list_args = sys_mylib_obj.list_cons (ref42_id, __temp_list_args);
    sys_gstack.add_frame(sys_tid, __temp_list_args);
    } ->
    conats_shared_release(sys_tid);
    loop_79__5{  sys_gstack.delete_frame(sys_tid);
    var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (sys_gstack.frame_get(sys_tid, 0, 2), __temp_list_args);
    sys_gstack.reload_frame(sys_tid, __temp_list_args);
    } ->
    producer_76(sys_tid)
  }
  ;

producer_76(sys_tid) =
  producer_76__1{  var __temp_list_args = sys_mylib_obj.list_nil ();
  __temp_list_args = sys_mylib_obj.list_cons (s_65, __temp_list_args);
  sys_gstack.add_frame(sys_tid, __temp_list_args);
  } ->
  conats_shared_acquire(sys_tid);
  producer_76__2{  var ref_78 = sys_gstack.retopr_frame(sys_tid);
  var env29_id = sys_mylib_obj.createTuple(1);
  sys_mylib_obj.setTupleElement(env29_id, 0, sys_gstack.frame_get(sys_tid, 0, 0));
  var loop_closure30_id = sys_mylib_obj.createTuple2(3, env29_id);
  var __temp_list_args = sys_mylib_obj.list_nil ();
  __temp_list_args = sys_mylib_obj.list_cons (ref_78, __temp_list_args);
  __temp_list_args = sys_mylib_obj.list_cons (env29_id, __temp_list_args);
  sys_gstack.reload_frame(sys_tid, __temp_list_args);
  } ->
  loop_79(sys_tid)
  ;

loop_91(sys_tid) =
  loop_91__1{  var loop_clo32_id = sys_mylib_obj.createTuple2(5, sys_gstack.frame_get(sys_tid, 0, 1));
  var x_8933_id = sys_mylib_obj.getTupleElement(sys_gstack.frame_get(sys_tid, 0, 1), 0);;
  sys_gstack.frame_push(sys_tid, x_8933_id);
  var __temp_list_args = sys_mylib_obj.list_nil ();
  __temp_list_args = sys_mylib_obj.list_cons (sys_gstack.frame_get(sys_tid, 0, 0), __temp_list_args);
  sys_gstack.add_frame(sys_tid, __temp_list_args);
  } ->
  lin_atomref_get_71(sys_tid);
  loop_91__2{  var temp16_id = sys_gstack.retopr_frame(sys_tid);
  var ref_93 = sys_mylib_obj.getTupleElement(temp16_id, 0);;
  sys_gstack.frame_push(sys_tid, ref_93);
  var v_94 = sys_mylib_obj.getTupleElement(temp16_id, 1);;
  var temp17_id = call(eq, v_94, 0);
  sys_gstack.frame_push(sys_tid, temp17_id);
  } ->
  if (sys_gstack.frame_get_bool(sys_tid, 0, 4)) {
    loop_91__1{  var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (s_65, __temp_list_args);
    __temp_list_args = sys_mylib_obj.list_cons (sys_gstack.frame_get(sys_tid, 0, 3), __temp_list_args);
    sys_gstack.add_frame(sys_tid, __temp_list_args);
    } ->
    conats_shared_condwait(sys_tid);
    loop_91__2{  var ref_95 = sys_gstack.retopr_frame(sys_tid);
    var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (ref_95, __temp_list_args);
    __temp_list_args = sys_mylib_obj.list_cons (sys_gstack.frame_get(sys_tid, 0, 1), __temp_list_args);
    sys_gstack.reload_frame(sys_tid, __temp_list_args);
    } ->
    loop_91(sys_tid)
  } else {
    loop_91__1{  var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (sys_gstack.frame_get(sys_tid, 0, 3), __temp_list_args);
    sys_gstack.add_frame(sys_tid, __temp_list_args);
    } ->
    lin_atomref_get_71(sys_tid);
    loop_91__2{  var temp45_id = sys_gstack.retopr_frame(sys_tid);
    var ref46_id = sys_mylib_obj.getTupleElement(temp45_id, 0);;
    var v47_id = sys_mylib_obj.getTupleElement(temp45_id, 1);;
    var temp48_id = call(sub, v47_id, 1);
    var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (ref46_id, __temp_list_args);
    __temp_list_args = sys_mylib_obj.list_cons (temp48_id, __temp_list_args);
    sys_gstack.add_frame(sys_tid, __temp_list_args);
    } ->
    lin_atomref_update_66(sys_tid);
    loop_91__3{  var ref49_id = sys_gstack.retopr_frame(sys_tid);
    var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (s_65, __temp_list_args);
    __temp_list_args = sys_mylib_obj.list_cons (ref49_id, __temp_list_args);
    sys_gstack.add_frame(sys_tid, __temp_list_args);
    } ->
    conats_shared_signal(sys_tid);
    loop_91__4{  var ref50_id = sys_gstack.retopr_frame(sys_tid);
    var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (s_65, __temp_list_args);
    __temp_list_args = sys_mylib_obj.list_cons (ref50_id, __temp_list_args);
    sys_gstack.add_frame(sys_tid, __temp_list_args);
    } ->
    conats_shared_release(sys_tid);
    loop_91__5{  sys_gstack.delete_frame(sys_tid);
    var __temp_list_args = sys_mylib_obj.list_nil ();
    __temp_list_args = sys_mylib_obj.list_cons (sys_gstack.frame_get(sys_tid, 0, 2), __temp_list_args);
    sys_gstack.reload_frame(sys_tid, __temp_list_args);
    } ->
    consumer_88(sys_tid)
  }
  ;

consumer_88(sys_tid) =
  consumer_88__1{  var __temp_list_args = sys_mylib_obj.list_nil ();
  __temp_list_args = sys_mylib_obj.list_cons (s_65, __temp_list_args);
  sys_gstack.add_frame(sys_tid, __temp_list_args);
  } ->
  conats_shared_acquire(sys_tid);
  consumer_88__2{  var ref_90 = sys_gstack.retopr_frame(sys_tid);
  var env35_id = sys_mylib_obj.createTuple(1);
  sys_mylib_obj.setTupleElement(env35_id, 0, sys_gstack.frame_get(sys_tid, 0, 0));
  var loop_closure36_id = sys_mylib_obj.createTuple2(5, env35_id);
  var __temp_list_args = sys_mylib_obj.list_nil ();
  __temp_list_args = sys_mylib_obj.list_cons (ref_90, __temp_list_args);
  __temp_list_args = sys_mylib_obj.list_cons (env35_id, __temp_list_args);
  sys_gstack.reload_frame(sys_tid, __temp_list_args);
  } ->
  loop_91(sys_tid)
  ;

// =====================

main_s(sys_tid) = 
  main_init{var __temp_list_args = sys_mylib_obj.list_nil ();
            sys_gstack.add_frame(0, __temp_list_args); 
            } ->
  main53_id__1{  gref_63 = atom_ref_manager.allocate(0);
  } ->
  main53_id__2{  lin_ref_64 = sys_mylib_obj.castvwtp0(gref_63);
  var mutex54_id = sys_mutex_manager.allocate();
  var cond55_id = sys_cond_manager.allocate();
  s_65 = sys_mylib_obj.createTuple(3);
  sys_mylib_obj.setTupleElement(s_65, 0, lin_ref_64);
  sys_mylib_obj.setTupleElement(s_65, 1, mutex54_id);
  sys_mylib_obj.setTupleElement(s_65, 2, cond55_id);
  tid1_100 = sys_tid_allocator.allocate();
  } ->
  main53_id__3{  tid2_101 = sys_tid_allocator.allocate();
  } ->
  sys_thread_create(tid1_100, 4, 0);
  sys_thread_create(tid2_101, 6, 0); 
  proc_thread_finalize(sys_tid);

main = main_s(sys_tid_allocator.allocate()) ||| Scheduler;

#define sys_assertion sys_assert_var == true;

#assert main deadlockfree;

#assert main |= G sys_assertion;


