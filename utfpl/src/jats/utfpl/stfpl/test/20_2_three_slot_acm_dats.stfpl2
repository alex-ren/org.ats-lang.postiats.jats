D2Cnone

staload "/tmp/conats35283137332619/conats.sats"

"D2Cstacsts" dataslots_t_736: (t@ype, int) -\> type

"D2Cstacsts" own_slot_vt_737: (int) -\> viewtype

local
in
  fun dataslots_create_63 = lamSta. lamSta. lam (<P2Tann>(x_64:int:t@ype), <P2Tann>(v_65:a_3901_0:t@ype:t@ype)) <fun> = 
    <D2EannSeff>(
      D2Ecst<conats_atomarrayref_create_2576:{a_3861_0:t@ype}(((int, a_3861_0:t@ype) -<fun> atomarrayref_727_0(a_3861_0:t@ype)))> (x_64, v_65):dataslots_t_736_0(a_3901_0:t@ype):type)
  fun dataslots_update_66 = lamSta. lamSta. lam (<P2Tann>(vpf_67:own_slot_vt_737_0():viewtype), <P2Tann>(slots_68:dataslots_t_736_0(a_3903_0:t@ype):type), <P2Tann>(i_69:int:t@ype), <P2Tann>(v_70:a_3903_0:t@ype:t@ype)) <fun> = 
    <D2EannSeff>(
      let
        val () = D2Ecst<conats_atomarrayref_update_2577:{a_3862_0:t@ype}(((atomarrayref_727_0(a_3862_0:t@ype), int, a_3862_0:t@ype) -<fun> void))> (slots_68, i_69, v_70)
      in
        (vpf_67 | ())
      end:@{0 = own_slot_vt_737_0(), 1 = void}:viewt0ype)
  fun dataslots_get_71 = lamSta. lamSta. lam (<P2Tann>(vpf_72:own_slot_vt_737_0():viewtype), <P2Tann>(slots_73:dataslots_t_736_0(a_3906_0:t@ype):type), <P2Tann>(i_74:int:t@ype)) <fun> = 
    <D2EannSeff>(
      let
        val v_75 = D2Ecst<conats_atomarrayref_get_2578:{a_3863_0:t@ype}(((atomarrayref_727_0(a_3863_0:t@ype), int) -<fun> a_3863_0:t@ype))> (slots_73, i_74)
      in
        (vpf_72 | v_75)
      end:@{0 = own_slot_vt_737_0(), 1 = a_3906_0:t@ype}:viewt0ype)
  prfun mc_acquire_ownership_76 = lamMet. lamSta. lam (<P2Tann>(i_77:int:t@ype)) <fun> = 
    <D2EannSeff>(
      D2Ecst<mc_vlock_get_2586:((int, int, int, int) -<fun> mc_vlock_vt_733_0())> (i_77, 0, 1, 1):own_slot_vt_737_0():viewtype)
  prfun mc_release_ownership_78 = lamMet. lamSta. lam (<P2Tann>(vpf_79:own_slot_vt_737_0():viewtype)) <fun> = 
    <D2EannSeff>(
      D2Ecst<mc_vlock_put_2587:((mc_vlock_vt_733_0()) -<fun> void)> (vpf_79):void:t@ype)
end

D2Cnone

val <P2Tann>(data_80:dataslots_t_736_0(int):type) = dataslots_create_63 (3, 0)

D2Cnone

val latest_81 = D2Ecst<conats_atomref_create_2573:{a_3857_0:t@ype}(((a_3857_0:t@ype) -<fun> atomref_726_0(a_3857_0:t@ype)))> (0)

val reading_82 = D2Ecst<conats_atomref_create_2573:{a_3857_0:t@ype}(((a_3857_0:t@ype) -<fun> atomref_726_0(a_3857_0:t@ype)))> (0)

D2Cnone

D2Cnone

val <P2Tann>(differ0_83:list_t_734_0(int):type) = D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (1, D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (2, D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (1, D2Ecst<list_nil_2589:{a_3889_0:t@ype}((() -<fun> list_t_734_0(a_3889_0:t@ype)))> ())))

val <P2Tann>(differ1_84:list_t_734_0(int):type) = D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (2, D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (2, D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (0, D2Ecst<list_nil_2589:{a_3889_0:t@ype}((() -<fun> list_t_734_0(a_3889_0:t@ype)))> ())))

val <P2Tann>(differ2_85:list_t_734_0(int):type) = D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (1, D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (0, D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (0, D2Ecst<list_nil_2589:{a_3889_0:t@ype}((() -<fun> list_t_734_0(a_3889_0:t@ype)))> ())))

val differ_86 = D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (differ0_83, D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (differ1_84, D2Ecst<list_cons_2590:{a_3890_0:t@ype}(((a_3890_0:t@ype, list_t_734_0(a_3890_0:t@ype)) -<fun> list_t_734_0(a_3890_0:t@ype)))> (differ2_85, D2Ecst<list_nil_2589:{a_3889_0:t@ype}((() -<fun> list_t_734_0(a_3889_0:t@ype)))> ())))

fun write_87 = lam (<P2Tann>(item_88:int:t@ype)) <fun> = 
  <D2EannSeff>(
    let
      val differx_89 = D2Ecst<list_get_element_2592:{a_3892_0:t@ype}(((list_t_734_0(a_3892_0:t@ype), int) -<fun> a_3892_0:t@ype))> (differ_86, D2Ecst<conats_atomref_get_2575:{a_3859_0:t@ype}(((atomref_726_0(a_3859_0:t@ype)) -<fun> a_3859_0:t@ype))> (latest_81))
      val index_90 = D2Ecst<list_get_element_2592:{a_3892_0:t@ype}(((list_t_734_0(a_3892_0:t@ype), int) -<fun> a_3892_0:t@ype))> (differx_89, D2Ecst<conats_atomref_get_2575:{a_3859_0:t@ype}(((atomref_726_0(a_3859_0:t@ype)) -<fun> a_3859_0:t@ype))> (reading_82))
      prval vpf_91 = mc_acquire_ownership_76 (index_90)
      val <P2Trec>(<LABP2ATnorm>(vpf_92), <LABP2ATnorm>(_)) = dataslots_update_66 (vpf_91, data_80, index_90, item_88)
      prval () = mc_release_ownership_78 (vpf_92)
      val () = D2Ecst<conats_atomref_update_2574:{a_3858_0:t@ype}(((atomref_726_0(a_3858_0:t@ype), a_3858_0:t@ype) -<fun> void))> (latest_81, index_90)
    in
      ()
    end:void:t@ype)

fun read_93 = lam () <fun> = 
  <D2EannSeff>(
    let
      val index_94 = D2Ecst<conats_atomref_get_2575:{a_3859_0:t@ype}(((atomref_726_0(a_3859_0:t@ype)) -<fun> a_3859_0:t@ype))> (latest_81)
      val () = D2Ecst<conats_atomref_update_2574:{a_3858_0:t@ype}(((atomref_726_0(a_3858_0:t@ype), a_3858_0:t@ype) -<fun> void))> (reading_82, index_94)
      prval vpf_95 = mc_acquire_ownership_76 (index_94)
      val <P2Trec>(<LABP2ATnorm>(vpf_96), <LABP2ATnorm>(item_97)) = dataslots_get_71 (vpf_95, data_80, index_94)
      prval () = mc_release_ownership_78 (vpf_96)
    in
      item_97
    end:int:t@ype)

fun loop_writer_98 = lam (<P2Tann>(x_99:int:t@ype)) <fun> = 
  <D2EannSeff>(
    let
      val () = write_87 (x_99)
    in
      loop_writer_98 (x_99)
    end:void:t@ype)

fun loop_reader_100 = lam (<P2Tann>(x_101:int:t@ype)) <fun> = 
  <D2EannSeff>(
    let
      val _ = read_93 ()
    in
      loop_reader_100 (x_101)
    end:void:t@ype)

val tid1_102 = D2Ecst<conats_tid_allocate_2579:(() -<fun> thread_id_t_728_0())> ()

val tid2_103 = D2Ecst<conats_tid_allocate_2579:(() -<fun> thread_id_t_728_0())> ()

val () = D2Ecst<conats_thread_create_2580:{a_3865_0:t@ype}(((((a_3865_0:t@ype) -<fun> void), a_3865_0:t@ype, thread_id_t_728_0()) -<fun> void))> (loop_reader_100, 0, tid1_102)

val () = D2Ecst<conats_thread_create_2580:{a_3865_0:t@ype}(((((a_3865_0:t@ype) -<fun> void), a_3865_0:t@ype, thread_id_t_728_0()) -<fun> void))> (loop_writer_98, 0, tid2_103)

%{
#assert main deadlockfree;

#assert main |= G sys_assertion;

%}