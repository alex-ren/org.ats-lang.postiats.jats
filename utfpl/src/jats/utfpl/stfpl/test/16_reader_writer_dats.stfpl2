staload "/home/grad2/aren/workspace/Postiats/projects/utfpl/src/jats/utfpl/stfpl/test/conats.sats"

val gref_63 = D2Ecst<conats_atomref_create_2568:{para:a_3842}(((para:a_3842) -<fun> atomref_726(para:a_3842))):type> (0)

val s_64 = D2Ecst<conats_shared_create_2560:{para:a_3836}(((para:a_3836) -<fun> shared_t_722(para:a_3836))):type> (gref_63)

fun producer_65 = lam (<P2Tann>(x_66:int:t@ype)) <fun> = 
  <D2EannFunclo><fun>(
    <D2EannSeff>(
      let
        val ref_67 = D2Ecst<conats_shared_acquire_2561:{para:a_3837}(((shared_t_722(para:a_3837)) -<fun> para:a_3837)):type> (s_64)
        fun loop_68 = lam () <clo> = 
          <D2EannSeff>(
            if (<D2Esym>(=) (D2Ecst<conats_atomref_get_2570:{para:a_3844}(((atomref_726(para:a_3844)) -<fun> para:a_3844)):type> (ref_67), 1)) then
              let
                val ref_69 = D2Ecst<conats_shared_condwait_2564:{para:a_3840}(((shared_t_722(para:a_3840), para:a_3840) -<fun> para:a_3840)):type> (s_64, ref_67)
              in
                loop_68 ()
              end
            else
              let
                val () = D2Ecst<conats_atomref_update_2569:{para:a_3843}(((atomref_726(para:a_3843), para:a_3843) -<fun> void)):type> (ref_67, <D2Esym>(+) (D2Ecst<conats_atomref_get_2570:{para:a_3844}(((atomref_726(para:a_3844)) -<fun> para:a_3844)):type> (ref_67), 1))
                val ref_70 = D2Ecst<conats_shared_signal_2563:{para:a_3839}(((shared_t_722(para:a_3839), para:a_3839) -<fun> para:a_3839)):type> (s_64, ref_67)
                val () = D2Ecst<conats_shared_release_2562:{para:a_3838}(((shared_t_722(para:a_3838), para:a_3838) -<fun> void)):type> (s_64, ref_70)
              in
                producer_65 (x_66)
              end)
      in
        loop_68 ()
      end:void:t@ype))

fun consumer_71 = lam (<P2Tann>(x_72:int:t@ype)) <fun> = 
  <D2EannFunclo><fun>(
    <D2EannSeff>(
      let
        val ref_73 = D2Ecst<conats_shared_acquire_2561:{para:a_3837}(((shared_t_722(para:a_3837)) -<fun> para:a_3837)):type> (s_64)
        fun loop_74 = lam () <clo> = 
          <D2EannSeff>(
            if (<D2Esym>(=) (D2Ecst<conats_atomref_get_2570:{para:a_3844}(((atomref_726(para:a_3844)) -<fun> para:a_3844)):type> (ref_73), 0)) then
              let
                val ref_75 = D2Ecst<conats_shared_condwait_2564:{para:a_3840}(((shared_t_722(para:a_3840), para:a_3840) -<fun> para:a_3840)):type> (s_64, ref_73)
              in
                loop_74 ()
              end
            else
              let
                val () = D2Ecst<conats_atomref_update_2569:{para:a_3843}(((atomref_726(para:a_3843), para:a_3843) -<fun> void)):type> (ref_73, <D2Esym>(-) (D2Ecst<conats_atomref_get_2570:{para:a_3844}(((atomref_726(para:a_3844)) -<fun> para:a_3844)):type> (ref_73), 1))
                val ref_76 = D2Ecst<conats_shared_signal_2563:{para:a_3839}(((shared_t_722(para:a_3839), para:a_3839) -<fun> para:a_3839)):type> (s_64, ref_73)
                val () = D2Ecst<conats_shared_release_2562:{para:a_3838}(((shared_t_722(para:a_3838), para:a_3838) -<fun> void)):type> (s_64, ref_76)
              in
                consumer_71 (x_72)
              end)
      in
        loop_74 ()
      end:void:t@ype))

val tid1_77 = D2Ecst<conats_tid_allocate_2574:(() -<fun> thread_id_t_728):type> ()

val tid2_78 = D2Ecst<conats_tid_allocate_2574:(() -<fun> thread_id_t_728):type> ()

val () = D2Ecst<conats_thread_create_2575:{para:a_3850}(((((para:a_3850) -<fun> void), para:a_3850, thread_id_t_728) -<fun> void)):type> (producer_65, 0, tid1_77)

val () = D2Ecst<conats_thread_create_2575:{para:a_3850}(((((para:a_3850) -<fun> void), para:a_3850, thread_id_t_728) -<fun> void)):type> (consumer_71, 0, tid2_78)